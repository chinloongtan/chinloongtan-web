<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/assets/favicon.png"/><meta name="keywords" content="react native, experienced, developer"/><title>Chin Loong Tan - Socket programming for file transfer application</title><meta name="title" content="Chin Loong Tan - Socket programming for file transfer application"/><meta name="description" content="The journey of 40x transfer speed improvement"/><meta name="next-head-count" content="10"/><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><link rel="preload" href="/_next/static/css/a6267c7a84eb05a5.css" as="style"/><link rel="stylesheet" href="/_next/static/css/a6267c7a84eb05a5.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-895f31a34bc8dd2f.js" defer=""></script><script src="/_next/static/chunks/framework-73b8966a3c579ab0.js" defer=""></script><script src="/_next/static/chunks/main-292e4726b4fd03ef.js" defer=""></script><script src="/_next/static/chunks/pages/_app-c164f2c72b92c6a5.js" defer=""></script><script src="/_next/static/chunks/b2e984c5-c6fb7c92049cce55.js" defer=""></script><script src="/_next/static/chunks/601-597bb24ff23733d9.js" defer=""></script><script src="/_next/static/chunks/675-7b1b173673ee7f53.js" defer=""></script><script src="/_next/static/chunks/518-ca43922f1257f114.js" defer=""></script><script src="/_next/static/chunks/238-0e74e6a6315ed36e.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bslug%5D-dbe089daa10fe21a.js" defer=""></script><script src="/_next/static/LIU_z3F2L-i1JY4WFdgAA/_buildManifest.js" defer=""></script><script src="/_next/static/LIU_z3F2L-i1JY4WFdgAA/_ssgManifest.js" defer=""></script><style data-href="https://fonts.googleapis.com/css?family=Raleway:400,500,700&display=swap">@font-face{font-family:'Raleway';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/raleway/v29/1Ptxg8zYS_SKggPN4iEgvnHyvveLxVvaorCIPrc.woff) format('woff')}@font-face{font-family:'Raleway';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/raleway/v29/1Ptxg8zYS_SKggPN4iEgvnHyvveLxVvoorCIPrc.woff) format('woff')}@font-face{font-family:'Raleway';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/raleway/v29/1Ptxg8zYS_SKggPN4iEgvnHyvveLxVs9pbCIPrc.woff) format('woff')}@font-face{font-family:'Raleway';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/raleway/v29/1Ptug8zYS_SKggPNyCAIT4ttDfCmxA.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Raleway';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/raleway/v29/1Ptug8zYS_SKggPNyCkIT4ttDfCmxA.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Raleway';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/raleway/v29/1Ptug8zYS_SKggPNyCIIT4ttDfCmxA.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Raleway';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/raleway/v29/1Ptug8zYS_SKggPNyCMIT4ttDfCmxA.woff2) format('woff2');unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Raleway';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/raleway/v29/1Ptug8zYS_SKggPNyC0IT4ttDfA.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Raleway';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/raleway/v29/1Ptug8zYS_SKggPNyCAIT4ttDfCmxA.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Raleway';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/raleway/v29/1Ptug8zYS_SKggPNyCkIT4ttDfCmxA.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Raleway';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/raleway/v29/1Ptug8zYS_SKggPNyCIIT4ttDfCmxA.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Raleway';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/raleway/v29/1Ptug8zYS_SKggPNyCMIT4ttDfCmxA.woff2) format('woff2');unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Raleway';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/raleway/v29/1Ptug8zYS_SKggPNyC0IT4ttDfA.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Raleway';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/raleway/v29/1Ptug8zYS_SKggPNyCAIT4ttDfCmxA.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Raleway';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/raleway/v29/1Ptug8zYS_SKggPNyCkIT4ttDfCmxA.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Raleway';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/raleway/v29/1Ptug8zYS_SKggPNyCIIT4ttDfCmxA.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Raleway';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/raleway/v29/1Ptug8zYS_SKggPNyCMIT4ttDfCmxA.woff2) format('woff2');unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Raleway';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/raleway/v29/1Ptug8zYS_SKggPNyC0IT4ttDfA.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style></head><body><div id="__next"><div class="blog-post-container content"><nav class="bg-white fixed top-0 left-0 w-full shadow flex items-center z-50" style="height:64px"><div class="relative flex-1 flex"><button type="button" class="p-4"><svg viewBox="0 0 24 24" style="width:1.5rem;height:1.5rem" role="presentation"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" style="fill:currentColor"></path></svg></button><div class="flex flex-1 text-xl font-medium items-center"><a href="/blog" class="">BLOG</a></div></div><div class="hidden md:hidden absolute bg-white w-full" style="top:64px"><a href="https://mvphub.app/" target="_blank" class="px-4 py-4 block border-t">SHOP</a><a href="/blog" target="_self" class="px-4 py-4 block border-t">BLOG</a><a href="/about" target="_self" class="px-4 py-4 block border-t">ABOUT</a></div></nav><div class="p-4 md:px-16 md:py-8 lg:px-32"><h2 class="font-bold text-2xl">Socket programming for file transfer application</h2><h6 class="text-md" style="color:#576366">8 November 2023</h6><h6 class="text-lg" style="color:#576366">The journey of 40x transfer speed improvement</h6><div style="flex-direction:row;display:flex;margin-top:10px;font-size:14px;flex-wrap:wrap"><a style="margin-right:10px;background-color:rgba(72, 52, 212, 0.3);padding:5px;padding-left:8px;padding-right:8px;border-radius:6px;font-family:Raleway;text-decoration:none;color:#4834d4" class="font-medium" href="/tags/react-native/">react-native<!-- --> </a><a style="margin-right:10px;background-color:rgba(253, 216, 53, 0.3);padding:5px;padding-left:8px;padding-right:8px;border-radius:6px;font-family:Raleway;text-decoration:none;color:#fdd835" class="font-medium" href="/tags/node.js">node.js<!-- --> </a></div><hr class="my-8"/><div class="prose lg:prose-xl"><p><a href="#solution">Jump to solution to see the improvement</a></p>
<p>About 3 months ago, I am looking to build an app to explore different type of application that can be built with React Native.</p>
<p>After a quick round of idea selection, I decided to build a <a href="https://play.google.com/store/apps/details?id=app.mvphub.filelinkup">file transfer app</a>. Part of the consideration being it scratches my own itch as I regularly transfer files between my Android and iOS devices.</p>
<h4>1. Introduction</h4>
<p>App should works</p>
<ul>
<li>Offline</li>
<li>Send original file without compression / loss of quality</li>
</ul>
<h4>2. Development Journey</h4>
<p>Initial attempt was to use bluetooth to achieve that. Since wearables and devices connect and sync data from each other as I experienced it.
Plus back in the days before cloud solutions, bluetooth file sharing was working okay.</p>
<p>Bluetooth technology quickly confuses me it&#x27;s variation like bluetooth vs. bluetooth low energy (BLE), scanning and connecting devices are a big hurdle before getting into transmitting data between devices.</p>
<p>Then, I am looking for feasible alternative and arrived at a WiFi network approach with TCP socket.
I am familiar with the paradigm with my experiences working with chat and video streaming applications.</p>
<p>A quick test of the setup with TCP server and client proofs that connecting devices are easier, and sending text data was achieved shortly after.</p>
<hr/>
<p>The first challenge surfaced and it was me asking myself &quot;How to send image using text string?&quot;.</p>
<p>Shortly afterward, I integrated an image picker library into the app and utilized the <code style="background-color:rgba(0,0,0,.04);padding-top:3px;padding-bottom:3px">base64</code> encoding to convert the image into a text string, which will be used to send over the connection.</p>
<p>While sending the image with <code style="background-color:rgba(0,0,0,.04);padding-top:3px;padding-bottom:3px">base64</code> from one side to the other has no issue, another challenge quickly arise.</p>
<p>&quot;How to know if the file content has finished sending?&quot; This is so that I can call the <code style="background-color:rgba(0,0,0,.04);padding-top:3px;padding-bottom:3px">save</code> function on the receiver, to save the file content.</p>
<p>Browsing through the internet, I understand that socket will continuously listening to data. It is up to me to either close the socket, and the last bit of data will be flushed out of the buffer and I can save the file when the event <code style="background-color:rgba(0,0,0,.04);padding-top:3px;padding-bottom:3px">onClose</code> is triggered.</p>
<p>That works if I am sending a single file, but what if I am sending multiple files (let&#x27;s say 100) in one go?</p>
<p>Now the alternative is to send a special string as a delimiter to indicate the termination of the file content.</p>
<p>With <code style="background-color:rgba(0,0,0,.04);padding-top:3px;padding-bottom:3px">base64</code> encoding, <code style="background-color:rgba(0,0,0,.04);padding-top:3px;padding-bottom:3px">@</code> is surely not part of the character that will exists, therefore it is a good candidate for this use case.</p>
<hr/>
<p>To think about data in socket connection is to imagine it as a continous string of data that keeps notify you when something new arrived.</p>
<p>Now that I know what to look for to split the data with a delimiter (let&#x27;s call it <code style="background-color:rgba(0,0,0,.04);padding-top:3px;padding-bottom:3px">@END@</code>), here comes the other challenge: knowing where does the file content starts.</p>
<p>There is a need to transmit information other than the file content. For example, information that informs sender to update the UI when the client successfully saved the file, or data that used for chat messages.</p>
<p>With the same approach used to determine the <code style="background-color:rgba(0,0,0,.04);padding-top:3px;padding-bottom:3px">@END@</code> of a content, now I need to have it for the beginning of a content, (let&#x27;s call it <code style="background-color:rgba(0,0,0,.04);padding-top:3px;padding-bottom:3px">@HEAD@</code>).</p>
<p>Now we are able to separate a whole chunk of content from start to end by identifying <code style="background-color:rgba(0,0,0,.04);padding-top:3px;padding-bottom:3px">@HEAD@</code> and <code style="background-color:rgba(0,0,0,.04);padding-top:3px;padding-bottom:3px">@END@</code>, regardless whether the content is a file content, or a stringified string.</p>
<hr/>
<p>When we are sending something in socket, it will not always send it out immediately. There is a concept known as <code style="background-color:rgba(0,0,0,.04);padding-top:3px;padding-bottom:3px">buffer</code> that keeps collecting the data and send it out in one go, and we have no control over when it will send out or wait.</p>
<p>We can imagine it as a waiting area for data to pile up and send out when it is ready.</p>
<p>This behaviour is important to understand because we need to design our system to be able to process the transmitted data that are not guaranteed to be in it&#x27;s own chunk from the sender&#x27;s intention.</p>
<p>For instance, before sending any content, I will send the header information to the client. From the client&#x27;s perspective, the first batch of data received, may comprise of header only data or header and content data.</p>
<p>So the client will need to handle that accordingly.</p>
<hr/>
<p>When everything is finally in place, I am able to send content between iOS and android devices. With different type of content such as stringified JSON for UI updates or text messages and Base64 string for file content that could be any file.</p>
<p>A huge milestone achieved! 🎉</p>
<p>Finally a working file transfer app, from initial ideation which I have no clue how exactly it can be done.</p>
<hr/>
<p>Then comes the next challenge.  Transfer speed is slow. Significantly slow with large file, and this is not even multiple files.</p>
<p>At this point, initially I am about to move on to other features that are more interesting to me, like scan for network for available devices to connect. This will greatly reduce the effort to initiate a transfer of file and have better user experience.</p>
<p>However, I chose to work on improving the transfer speed instead. I simply couldn&#x27;t bear with the slow transfer speed. Despite this means that I probably need to work on native code, which has high degree of uncertainties but I am determined it can be done.</p>
<hr/>
<p>First step of transfer speed optimization begins with revisiting the existing algorithm that process the incoming data from socket connection.</p>
<p>With careful refactoring and simplifying logic in loops, I managed to improve the transfer speed from ~100Kbps to ~300Kbps.</p>
<p>That&#x27;s 3 times of improvement and have obvious reduction in transfer time. However, the goal is to reach above 1000Kbps because that&#x27;s what the active incumbents on the market are offering, and I am convinced it can be done, with React Native.</p>
<p>Also because that&#x27;s what the whole point of starting this project, to explore and push the limit of app built with React Native.</p>
<p>The next junction of optimization leads to which path to take to achieve the goal of 1000Kbps transfer speed.</p>
<p>I could either:</p>
<ul>
<li>Optimize Javascript code in hope for the next 3x improvement</li>
<li>Opt for React Native&#x27;s new architecture</li>
<li>Work with native platform code</li>
</ul>
<p>What I have done was all 3 of them, in the order of the list above.</p>
<p>Well, fast forward today and looking back to the decision, I would still make the same decision if I were to choose again.</p>
<hr/>
<p>There isn&#x27;t anymore room for optimization working on Javascript code and logic. The bottleneck is the <code style="background-color:rgba(0,0,0,.04);padding-top:3px;padding-bottom:3px">bridge</code> that is used for communication between native and JS code.</p>
<p>I came to this realization after spending more time looking for a simple tweak but unfortunately, no easy fix using this approach.</p>
<p>The next step was to try out the new architecture and hopefully transfer speed will just be faster.</p>
<p>Lots of experimentation: enabling new architecture, learn <code style="background-color:rgba(0,0,0,.04);padding-top:3px;padding-bottom:3px">Codegen</code>, <code style="background-color:rgba(0,0,0,.04);padding-top:3px;padding-bottom:3px">Turbo modules</code>, working with custom JSI binding to send data between native and JS without the bridge, configuring <code style="background-color:rgba(0,0,0,.04);padding-top:3px;padding-bottom:3px">CMakeLists.txt</code> for <code style="background-color:rgba(0,0,0,.04);padding-top:3px;padding-bottom:3px">C++</code> build, benchmark the performance and so on.</p>
<p>After spending 2 weeks learning the rope, the result is not up to expectation. Enabling the new architecture is not a silver bullet for the problem. No significant improve in speed.</p>
<hr/>
<p>Despite heading into the wrong direction and invested time without fruitful outcome, finally it is now clear to me, with more learning from the internet about the problem, that I can do it with native module, without new architecture.</p>
<p>The next steps is to read and browse through the source code of existing native module and figure out a solution.</p>
<p><a name="solution" href="">So here is the solution:</a></p>
<p><img alt="diagram" node="[object Object]" post="[object Object]" loading="lazy" width="746" height="423" decoding="async" data-nimg="1" style="color:transparent;width:100%;height:auto;background-size:cover;background-position:50% 50%;background-repeat:no-repeat;background-image:url(&quot;data:image/svg+xml;charset=utf-8,%3Csvg xmlns=&#x27;http%3A//www.w3.org/2000/svg&#x27; viewBox=&#x27;0 0 8 5&#x27;%3E%3Cfilter id=&#x27;b&#x27; color-interpolation-filters=&#x27;sRGB&#x27;%3E%3CfeGaussianBlur stdDeviation=&#x27;1&#x27;/%3E%3C/filter%3E%3Cimage preserveAspectRatio=&#x27;none&#x27; filter=&#x27;url(%23b)&#x27; x=&#x27;0&#x27; y=&#x27;0&#x27; height=&#x27;100%25&#x27; width=&#x27;100%25&#x27; href=&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAFCAAAAABd+vKJAAAANUlEQVR42mNQ1DXz8PExMWTQsXU0tzZzdGdQ0NZx8HDUM2BQNtbVszRUs2XQtrFQ1FQ28AYAwI4IR7odxKUAAAAASUVORK5CYII=&#x27;/%3E%3C/svg%3E&quot;)" src="/_next/static/media/flow.52ec5b9b.png"/></p>
<p>The transfer speed improve tremendously, exceeded my initial goal way beyond my expectation. It&#x27;s mind blowing that it reaches 12,000Kbps in good network condition. 🤯 40x improvement from 300Kbps to 12,000Kbps.</p>
<p>Transferring videos and huge files are way much faster now, and multiple files transfer has no issue as well with fast transfer speed.</p>
<p>I am glad it worked out that way but I am far from done with the application. There are just so many exciting features I wanted to implement. It&#x27;s time to take a break from this development and it&#x27;s a joy to use to use this app on a weekly basis to transfer files.</p>
<p>Check out the app and let me know what you think!</p>
<p><a href="https://apps.apple.com/us/app/file-link-up/id6464361724">iOS</a></p>
<p><a href="https://play.google.com/store/apps/details?id=app.mvphub.filelinkup">Android</a></p>
<p>Thanks for reading, cheers!</p></div></div><footer class="p-4 md:p-8 lg:p-16"><div class=""><h4 class="text-xl mb-4">Contact me via:</h4><a href="https://www.linkedin.com/in/chinloongtan" target="_blank" rel="noopener noreferrer" style="color:white" class="flex items-center"><div class="w-10"><svg viewBox="0 0 24 24" style="width:1.5rem;height:1.5rem" role="presentation"><path d="M19 3A2 2 0 0 1 21 5V19A2 2 0 0 1 19 21H5A2 2 0 0 1 3 19V5A2 2 0 0 1 5 3H19M18.5 18.5V13.2A3.26 3.26 0 0 0 15.24 9.94C14.39 9.94 13.4 10.46 12.92 11.24V10.13H10.13V18.5H12.92V13.57C12.92 12.8 13.54 12.17 14.31 12.17A1.4 1.4 0 0 1 15.71 13.57V18.5H18.5M6.88 8.56A1.68 1.68 0 0 0 8.56 6.88C8.56 5.95 7.81 5.19 6.88 5.19A1.69 1.69 0 0 0 5.19 6.88C5.19 7.81 5.95 8.56 6.88 8.56M8.27 18.5V10.13H5.5V18.5H8.27Z" style="fill:currentColor"></path></svg></div>chinloongtan</a><div class="mb-0 mt-2 text-white"><a href="mailto:me@chinloongtan.com?body=Hi Chin Loong,
" style="color:white" class="flex items-center"><div class="w-10"><svg viewBox="0 0 24 24" style="width:1.5rem;height:1.5rem" role="presentation"><path d="M22 6C22 4.9 21.1 4 20 4H4C2.9 4 2 4.9 2 6V18C2 19.1 2.9 20 4 20H20C21.1 20 22 19.1 22 18V6M20 6L12 11L4 6H20M20 18H4V8L12 13L20 8V18Z" style="fill:currentColor"></path></svg></div>me@chinloongtan.com</a></div></div><div class="mt-6 md:mt-16"><h4 class="text-xl mb-4">Or Buy Me A Coffee:</h4><a href="https://www.buymeacoffee.com/chinloongtan" target="_blank" rel="noopener noreferrer" style="color:white" class="flex items-center"><div class="w-10"><svg viewBox="0 0 24 24" style="width:1.5rem;height:1.5rem" role="presentation"><path d="M2,21V19H20V21H2M20,8V5H18V8H20M20,3A2,2 0 0,1 22,5V8A2,2 0 0,1 20,10H18V13A4,4 0 0,1 14,17H8A4,4 0 0,1 4,13V3H20M16,5H6V13A2,2 0 0,0 8,15H14A2,2 0 0,0 16,13V5Z" style="fill:currentColor"></path></svg></div>chinloongtan</a></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"content":"\n[Jump to solution to see the improvement](#solution)\n\nAbout 3 months ago, I am looking to build an app to explore different type of application that can be built with React Native.\n\nAfter a quick round of idea selection, I decided to build a [file transfer app](https://play.google.com/store/apps/details?id=app.mvphub.filelinkup). Part of the consideration being it scratches my own itch as I regularly transfer files between my Android and iOS devices.\n\n#### 1. Introduction\n\nApp should works\n\n- Offline\n- Send original file without compression / loss of quality\n\n#### 2. Development Journey\n\nInitial attempt was to use bluetooth to achieve that. Since wearables and devices connect and sync data from each other as I experienced it.\nPlus back in the days before cloud solutions, bluetooth file sharing was working okay.\n\nBluetooth technology quickly confuses me it's variation like bluetooth vs. bluetooth low energy (BLE), scanning and connecting devices are a big hurdle before getting into transmitting data between devices.\n\nThen, I am looking for feasible alternative and arrived at a WiFi network approach with TCP socket.\nI am familiar with the paradigm with my experiences working with chat and video streaming applications.\n\nA quick test of the setup with TCP server and client proofs that connecting devices are easier, and sending text data was achieved shortly after.\n\n---\n\nThe first challenge surfaced and it was me asking myself \"How to send image using text string?\".\n\nShortly afterward, I integrated an image picker library into the app and utilized the `base64` encoding to convert the image into a text string, which will be used to send over the connection.\n\nWhile sending the image with `base64` from one side to the other has no issue, another challenge quickly arise.\n\n\"How to know if the file content has finished sending?\" This is so that I can call the `save` function on the receiver, to save the file content.\n\nBrowsing through the internet, I understand that socket will continuously listening to data. It is up to me to either close the socket, and the last bit of data will be flushed out of the buffer and I can save the file when the event `onClose` is triggered.\n\nThat works if I am sending a single file, but what if I am sending multiple files (let's say 100) in one go?\n\nNow the alternative is to send a special string as a delimiter to indicate the termination of the file content.\n\nWith `base64` encoding, `@` is surely not part of the character that will exists, therefore it is a good candidate for this use case.\n\n---\n\nTo think about data in socket connection is to imagine it as a continous string of data that keeps notify you when something new arrived.\n\nNow that I know what to look for to split the data with a delimiter (let's call it `@END@`), here comes the other challenge: knowing where does the file content starts.\n\nThere is a need to transmit information other than the file content. For example, information that informs sender to update the UI when the client successfully saved the file, or data that used for chat messages.\n\nWith the same approach used to determine the `@END@` of a content, now I need to have it for the beginning of a content, (let's call it `@HEAD@`).\n\nNow we are able to separate a whole chunk of content from start to end by identifying `@HEAD@` and `@END@`, regardless whether the content is a file content, or a stringified string.\n\n---\n\nWhen we are sending something in socket, it will not always send it out immediately. There is a concept known as `buffer` that keeps collecting the data and send it out in one go, and we have no control over when it will send out or wait.\n\nWe can imagine it as a waiting area for data to pile up and send out when it is ready.\n\nThis behaviour is important to understand because we need to design our system to be able to process the transmitted data that are not guaranteed to be in it's own chunk from the sender's intention.\n\nFor instance, before sending any content, I will send the header information to the client. From the client's perspective, the first batch of data received, may comprise of header only data or header and content data.\n\nSo the client will need to handle that accordingly.\n\n---\n\nWhen everything is finally in place, I am able to send content between iOS and android devices. With different type of content such as stringified JSON for UI updates or text messages and Base64 string for file content that could be any file.\n\nA huge milestone achieved! 🎉\n\nFinally a working file transfer app, from initial ideation which I have no clue how exactly it can be done.\n\n---\n\nThen comes the next challenge.  Transfer speed is slow. Significantly slow with large file, and this is not even multiple files.\n\nAt this point, initially I am about to move on to other features that are more interesting to me, like scan for network for available devices to connect. This will greatly reduce the effort to initiate a transfer of file and have better user experience.\n\nHowever, I chose to work on improving the transfer speed instead. I simply couldn't bear with the slow transfer speed. Despite this means that I probably need to work on native code, which has high degree of uncertainties but I am determined it can be done.\n\n---\n\nFirst step of transfer speed optimization begins with revisiting the existing algorithm that process the incoming data from socket connection.\n\nWith careful refactoring and simplifying logic in loops, I managed to improve the transfer speed from ~100Kbps to ~300Kbps.\n\nThat's 3 times of improvement and have obvious reduction in transfer time. However, the goal is to reach above 1000Kbps because that's what the active incumbents on the market are offering, and I am convinced it can be done, with React Native.\n\nAlso because that's what the whole point of starting this project, to explore and push the limit of app built with React Native.\n\nThe next junction of optimization leads to which path to take to achieve the goal of 1000Kbps transfer speed.\n\nI could either:\n\n- Optimize Javascript code in hope for the next 3x improvement\n- Opt for React Native's new architecture\n- Work with native platform code\n\nWhat I have done was all 3 of them, in the order of the list above.\n\nWell, fast forward today and looking back to the decision, I would still make the same decision if I were to choose again.\n\n---\n\nThere isn't anymore room for optimization working on Javascript code and logic. The bottleneck is the `bridge` that is used for communication between native and JS code.\n\nI came to this realization after spending more time looking for a simple tweak but unfortunately, no easy fix using this approach.\n\nThe next step was to try out the new architecture and hopefully transfer speed will just be faster.\n\nLots of experimentation: enabling new architecture, learn `Codegen`, `Turbo modules`, working with custom JSI binding to send data between native and JS without the bridge, configuring `CMakeLists.txt` for `C++` build, benchmark the performance and so on.\n\nAfter spending 2 weeks learning the rope, the result is not up to expectation. Enabling the new architecture is not a silver bullet for the problem. No significant improve in speed.\n\n---\n\nDespite heading into the wrong direction and invested time without fruitful outcome, finally it is now clear to me, with more learning from the internet about the problem, that I can do it with native module, without new architecture.\n\nThe next steps is to read and browse through the source code of existing native module and figure out a solution.\n\n\u003ca name=\"solution\"\u003eSo here is the solution:\u003c/a\u003e\n\n![diagram](flow.png)\n\nThe transfer speed improve tremendously, exceeded my initial goal way beyond my expectation. It's mind blowing that it reaches 12,000Kbps in good network condition. 🤯 40x improvement from 300Kbps to 12,000Kbps.\n\nTransferring videos and huge files are way much faster now, and multiple files transfer has no issue as well with fast transfer speed.\n\nI am glad it worked out that way but I am far from done with the application. There are just so many exciting features I wanted to implement. It's time to take a break from this development and it's a joy to use to use this app on a weekly basis to transfer files.\n\nCheck out the app and let me know what you think!\n\n[iOS](https://apps.apple.com/us/app/file-link-up/id6464361724)\n\n[Android](https://play.google.com/store/apps/details?id=app.mvphub.filelinkup)\n\nThanks for reading, cheers!\n","frontmatter":{"path":"/blog/socket-programming-for-file-transfer-application","date":"2023-11-08T09:30:00.000Z","title":"Socket programming for file transfer application","excerpt":"The journey of 40x transfer speed improvement","tags":["react-native","node.js"]},"fullPath":"/Users/chinloong/makespace/chinloongtan-web/src/content/blog/2023/11/08-socket-programming/index.md","timeToRead":7}},"__N_SSG":true},"page":"/blog/[slug]","query":{"slug":"socket-programming-for-file-transfer-application"},"buildId":"LIU_z3F2L-i1JY4WFdgAA","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>